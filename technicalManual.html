<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Store Calls System - Manuals</title>
        <meta name="viewport" content="width=device-width" />
        <link rel="stylesheet" type="text/css" href="css/foundation.css">
        <link rel="stylesheet" type="text/css" href="css/app.css">
        <script src="js/modernizr.js"></script>
    </head>
    <body>
        <nav class="top-bar" data-topbar role="navigation">
          <ul class="title-area">
            <li class="name">
              <h1><a href="/">Store Calls Manuals</a></h1>
            </li>
             <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
            <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
          </ul>

          <section class="top-bar-section">
            <!-- Left Nav Section -->
            <ul class="left">
                <li><a href="userManual.html">User Manual</a></li>
                <li><a href="technicalManual.html">Technical Manual</a></li>
            </ul>
          </section>
        </nav>
        <div data-magellan-expedition="fixed">
          <dl class="sub-nav">
            <dd data-magellan-arrival="contents"><a href="#contents">Contents</a></dd>
            <dd data-magellan-arrival="overview"><a href="#overview">Overview</a></dd>
            <dd data-magellan-arrival="architecture"><a href="#architecture">Architecture</a></dd>
            <dd data-magellan-arrival="database"><a href="#database">Database design</a></dd>
            <dd data-magellan-arrival="high"><a href="#high">High level design</a></dd>
            <dd data-magellan-arrival="user_interface"><a href="#user_interface">User Interface design</a></dd>
            <dd data-magellan-arrival="validation"><a href="#validation">Validation</a></dd>
            <dd data-magellan-arrival="authentication"><a href="#authentication">Authentication</a></dd>
            <dd data-magellan-arrival="implementation"><a href="#implementation">Implementation</a></dd>
          </dl>
        </div>
         <section class="large-12 small-12 columns">
          <h3 class="cheaders">Technical Manual</h3>
          <hr class="chr">
          <div id="contents">
            <a name="contents"></a>
            <h4 data-magellan-destination="contents" class="cheaders"> Contents:</h4>
            <p>The technical manual has the following contents: </p>
            <ul class="customList">
              <li><a href="#overview">1. Overview</a></li>
              <li><a href="#architecture">2. Architecture</a></li>
              <li><a href="#database">3. Database design</a></li>
              <li><a href="#high">4. High level design</a></li>
              <li><a href="#user_interface">5. User interface design</a></li>
              <li><a href="#validation">6. Validation</a></li>
              <li><a href="#authentication">7. Authentication</a></li>
              <li><a href="#implementation">8. Implementation</a></li>
            </ul>
          </div>
          <div id="overview">
            <a id="overview"></a>
            <h4 data-magellan-destination="overview" class="cheaders">1. Overview</h4>
            <hr class="chr">
            <p>The technical manual document outlines the technical details of architecture, design and implementation of the system. The documents presents a high level design consisting of the main functionality the program does and afterwards a detailed design is included in order to demostrate what is intended to be achieved with the implementation.</p>
          </div>
          <div id="architecture">
            <a id="architecture"></a>
            <h4 data-magellan-destination="architecture" class="cheaders">2. Architecture</h4>
            <hr class="chr">
            <p>The system is build using ASP.NET MVC and a SQL Express Database. The Model-View-Controller (MVC) architectural pattern separates an application into three main components: models, views and controllers. The main advantages of using an MVC pattern are:</p>
            <ul class="customList">
              <li>It makes easier to manage a complex application.</li>
              <li>Enables full control over the rendered HTML.</li>
              <li>The application follows a natural cycle: when a user takes an action, the data models changes and delivers an updated view to the user.</li>
              <li>ASP.NET MVC helps the developer to produce clean, standard markup using HTML helper methods.</li>
              <li>Given the fact that the application is separated in layers, it makes easier to test each component individually.</li>
              <li>Powerful routing system (more similar to RestFul). For example, instead of URLs like this: <code>/App_v2/User/Page.aspx?action=show%20prop&prop_id=82742</code> uses URLs like: <code>/to-rent/chicago/2303-silver-street</code>.</li>
            </ul>
            <br />
            <p>The next diagram shows how the application is separated in layers, the comunication among components and the contents of each one.</p>
            <img src="images/architecture.png" alt="architecture"><br />
            <span class="imgNote">[Image 1]. Architecture of the system.</span>
            <blockquote>References: <a href="http://msdn.microsoft.com/en-us/library/dd381412%28v=vs.108%29.aspx"> ASP.NET MVC Overview</a>, <a href="http://stackoverflow.com/questions/102558/biggest-advantage-to-using-asp-net-mvc-vs-web-forms"> ASP.NET MVC advantages</a>, Pro ASP.NET MVC 4 (Professional Apress) 4th. Apress Berkely, CA, USA Â©2013. ISBN:1430242361 9781430242369</blockquote>
          </div>
          <div id="database">
            <a id="database"></a>
            <h4 data-magellan-destination="database" class="cheaders">3. Database design</h4>
            <hr class="chr">
            <p>Two databases are used in the system, one is the default database used for users and roles; the other was designed specifically for the system. The next diagram shows the design of the databases and both are linked.</p>
          </div>
          <div id="high">
            <a id="high"></a>
            <h4 data-magellan-destination="high" class="cheaders">4. High level design</h4>
            <hr class="chr">
            <p>The user can perform different actions in the system. The following diagrams shows how the diagram communicates among its components when the user sends a request to the system.</p>
            <section class="small-12 large-12 columns">
              <div class="small-12 large-3 panel columns">
                <p>The diagram from the right shows the interaction among the components when a user register on the system (<a id="register_design_show">show</a> | <a id="register_design_hide">hide</a>).</p>
              </div>
              <div id="register_design" class="small-12 large-9 panel columns">
                <p><span class="important">Register. </span></p>
                <img src="images/register_design.png" alt="register new user"><br />
                <span class="imgNote">[Image 2]. A new user registers on the system.</span>
              </div>
            </section>
            <!-- login design -->
            <section class="small-12 large-12 columns">
              <div class="small-12 large-3 panel columns">
                <p>The diagram from the right shows the interaction among the components when a user log into the system (<a id="login_design_show">show</a> | <a id="login_design_hide">hide</a>).</p>
              </div>
              <div id="login_design" class="small-12 large-9 panel columns">
                <p><span class="important">Login. </span></p>
                <img src="images/register_design.png" alt="register new user"><br />
                <span class="imgNote">[Image 3]. A new user registers on the system.</span>
              </div>
            </section>
            <!-- registration call design -->
            <section class="small-12 large-12 columns">
              <a id="callRegistration"></a>
              <div class="small-12 large-3 panel columns">
                <p>The diagram from the right shows the interaction among the components when a user registers a call on the system (<a id="call_design_show">show</a> | <a id="call_design_hide">hide</a>).It is assumed that the user is already logged into the system.</p>
              </div>
              <div id="call_design" class="small-12 large-9 panel columns">
                <p><span class="important">Call registration. </span></p>
                <img src="images/call_design.png" alt="register call design"><br />
                <span class="imgNote">[Image 4]. A new call registration is stored on the system.</span>
              </div>
            </section>
            <!-- search design -->
            <section class="small-12 large-12 columns">
            <a id="searchPerson"></a>
              <div class="small-12 large-3 panel columns">
                <p>The diagram from the right shows the interaction among the components when a wants to perform a search for a person on the system (<a id="search_design_show">show</a> | <a id="search_design_hide">hide</a>). It is assumed that the user is already logged into the system and it has access to the module.</p>
              </div>
              <div id="search_design" class="small-12 large-9 panel columns">
                <p><span class="important">Search. </span></p>
                <img src="images/search_design.png" alt="search design"><br />
                <span class="imgNote">[Image 5]. Search of a person.</span>
              </div>
            </section>
            <!-- charts design -->
            <section class="small-12 large-12 columns">
            <a id="chartsFlow"></a>
              <div class="small-12 large-3 panel columns">
                <p>The diagram from the right shows the interaction among the components when a wants to generate the charts on the system (<a id="charts_design_show">show</a> | <a id="charts_design_hide">hide</a>). It is assumed that the user is already logged into the system and it has access to the module.</p>
              </div>
              <div id="charts_design" class="small-12 large-9 panel columns">
                <p><span class="important">Charts. </span></p>
                <img src="images/charts_design.png" alt="charts design"><br />
                <span class="imgNote">[Image 6]. Charts components interaction.</span>
              </div>
            </section>
          </div> <!-- high level design -->
          <!-- User interface section -->
          <div id="user_interface" class="small-12 large-12 columns">
            <a id="user_interface"></a>
            <h4 data-magellan-destination="user_interface" class="cheaders">5. User interface design</h4>
            <hr class="chr">
            <p class="panel callout radius">The system is built using the front-end framework called <span class="important">Foundation.</span> The framework is designed by dividing the width of the screen in twelve columns, which can be configured for small, medium or large devices. Besides to provide a responsive design, it also offer many interface elements, some of the important elements used on the system are: </p>
              <!-- Navigation menu -->
              <div class="large-7 small-12 panel columns">
                <ul class="customList">
                  <li><span class="important">Navigation menu.</span> It provides the navigation on the system to access the different modules. Also, the menu respond to the size of the screen.</li>
                </ul>
                <img src="images/nav.png" alt="navigation menu code"><br />
                <span class="imgNote">[Image 7]. Navigation menu, code in "/Views/Shared/_Layout.cshtml".</span>
              </div>
              <div class="large-5 small-12 columns">
                <p>Besides of using the CSS from Foundation, it is required to add the following scripts in order to have a responsive design.</p>
                <code>
                  @Scripts.Render("~/bundles/jquery")
                  @Scripts.Render("~/Scripts/foundation.js")
                  @Scripts.Render("~/Scripts/foundation.topbar.js")
                </code>
                <p>And include the next line of code inside a script, after the call to the javascript files mentioned.</p>
                <code>
                  $(document).foundation();
                </code>
                <p><span class="imgNote">Code in "/Views/Shared/_Layout.cshtml".</span></p>
              </div>
              <!-- end navigation menu-->
            <!-- Responsive tables -->
            <div class="large-7 small-12 panel columns">
              <ul class="customList">
                <li><span class="important">Responsive tables.</span></li>
              </ul>
              <img src="images/responsive_tables.png" alt="responsive tables"><br />
              <span class="imgNote">[Image 8]. Responsive tables, code in "/Views/Shared/_Layout.cshtml".</span>
            </div>
            <div class="large-5 small-12 columns">
              <p>To get the responsive tables work it is required to add the javascript: <code>@Scripts.Render("~/Scripts/responsive-tables.js")</code> and the CSS <code>@Styles.Render("~/Content/responsive-tables.css")</code>.</p>
              <p><span class="imgNote">Code in "/Views/Shared/_Layout.cshtml".</span></p>
            </div>
            <!-- Responsive -->
            <div class="large-12 small-12 columns">
              <p>The next screenshot shows how the system looks in different sizes, depending on the device (<a id="responsive_design_show">show</a> | <a id="responsive_design_hide">hide</a>).</p>
              <div id="responsive_design" class="large-8 small-12 panel columns" style="display:none">
                <img src="images/responsive.png" alt="responsive system"><br />
                <span class="imgNote">[Image 9]. Responsive system. <a href="http://ami.responsivedesign.is/">Am I responsive?</a>.</span>
              </div>
            </div>
            <div class="large-12 small-12 columns">
              <blockquote>References: <a href="http://foundation.zurb.com/docs/"> Foundation Documentation</a>, <a href="http://ami.responsivedesign.is/"> Am I responsive?</a></blockquote>
            </div>
            <!-- end Responsive -->
          </div> <!-- end user interface -->
          <!-- validation section -->
          <div id="validation" class="small-12 large-12 columns">
            <a id="validation"></a>
            <h4 data-magellan-destination="validation" class="cheaders">6. Validation</h4>
            <hr class="chr">
            <div class="panel callout radius">
              <p>All the forms used in the system has validation to configure, to prevent the user to submit empty or wrong information. The configuration of the validation is divided in two parts: 
              </p>
              <ol class="customList">
                <li>In the Model for each property that by design it needs to be checked. This way to do it allow us to take advantage of Razor and generate HTML in a clean and faster way.</li>
                <li>In the View using Razor syntax, specifiying which property of the model and indicating that its for validation</li>
              </ol>
            </div>
            <p>For example:</p>
            <p>The Model Registration <span class="imgNote">(code in "/Models/Registration.cs")</span> specifies which data is required and the text for the label.</p>
            <p>
            <pre>
            [Required(ErrorMessage = "A phone number is required")]
            [Display(Name = "Phone number:")]
            public int PhoneNumber { get; set; }
            </pre>
            </p>
            <p>In the View <span class="imgNote">(code in "/Views/Call/Register.cshtml")</span> at the top of the page it specifies which Model is going to be used for the view. To retrieve or assign data from the model is as follows:</p>
            <p>Set validation to true <code>@Html.ValidationSummary(true)</code> and then
            <br/>
            <pre>
            @Html.LabelFor(m => m.PhoneNumber)(gets the display name: "Phone number")
            @Html.TextBoxFor(m => m.PhoneNumber)(assign the value to PhoneNumber)
            @Html.ValidationMessageFor(m => m.PhoneNumber)(gets the ErrorMessage: "A phone number is required")
            </pre>
            </p>
            <p>
            In case the user submits the form with one or more empty fields the error message will be displayed. Same behavior when using Ajax, the system will not communicate with the server until the data is correct.</p>
            <div class="panel">
              <img src="images/validation.png" alt="validation message"><br />
              <span class="imgNote">[Image 10]. Validation message.</span>
            </div>
            <div class="panel">
              <p><span class="important">Note: </span> this only shows an example of how validation is configured in one of the models from the project, the models/views that have validation are:</p>
              <ul>
                <li>Model Registration.cs <span class="imgNote">(code in "/Models/Registration.cs")</span> / View: Call/Register <span class="imgNote">(code in "/Views/Call/Register.cshtml")</span>.</li>
                <li>Model Search.cs <span class="imgNote">(code in "/Models/Search.cs")</span> / View: Person/Search <span class="imgNote">(code in "/Views/Person/Search.cshtml")</span>.</li>
                <li>Model Chart.cs <span class="imgNote">(code in "/Models/Chart.cs")</span> / View: Chart/Index <span class="imgNote">(code in "/Views/Chart/Index.cshtml")</span>.</li>
              </ul>
            </div>
          </div><!-- End validation -->
          <!--Authentication -->
          <div id="authentication" class="small-12 large-12 columns">
            <a id="authentication"></a>
            <h4 data-magellan-destination="authentication" class="cheaders">7. Authorization</h4>
            <hr class="chr">
            <div class="panel callout radius">
              <p>The user must have authorization to access the modules, by defaut it can only access to registration call. <span class="important">AuthorizeCore: </span> it is an ovverriden method in order to check wheter the user is being authorized. Has two parameters:</p>
              <ul>
                <li>HtttpContext: It is for collecting an information about each single request. It returns false if the user is not authorized.</li>
                <li>OnAuthorization: It is an overriden method in order to redirect the user to Unauthorized page. According to (MSDN), this method is called "when a process requests authorization"</li>
              </ul>
            </div>
            <div class="small-12 large-6 panel columns">
              <img src="images/Authorize.jpg" alt="authorize"><br />
              <span class="imgNote">[Image 11]. Validation message.</span>
              <br />
              <p><span class="important">Note: </span> the code can be found in the controller "AuthorizeAttribute" can be found at: /controllers/AuthorizeAttribute.cs.</p>
            </div>
          </div>
          <!-- end authentication -->
          <!-- implementation section -->
          <div id="implementation" class="small-12 large-12 columns">
            <a id="implementation"></a>
            <h4 data-magellan-destination="implementation" class="cheaders">8. Implementation</h4>
            <hr class="chr">
            <div class="panel callout radius">
              <p>An explanation and features of each module from the system are going to be presented in this section.</p>
            </div>
            <div class="small-12 large-12 columns"> <!-- register -->
              <h5 class="cheaders">8.1 Register</h5>
              <hr class="chr">
              <div class="panel callout radius">
                <p>In case that the information has been entered correctly, the data will be stored in database by a WebSecurity.CreateUserAndAccount(model.UserName, model.Password) method and direct the user to Registration Page for call. Another important elements are:</p>
                <ul>
                  <li>[AllowAnnonymous]: It is an attribute</li>
                  <li>[ValidateAntiForgeryToken]: It is an attribute used to "prevent forgery of a request"</li>
                  <li>ModelState.IsValid: ModelSate "represents the state of an attempt to bind a poster form to an action method, which includes validation information. Where isValid gets a value determining if instance of this model-stat dictiornary is valid". For example, passing a string for a parameter which should be an integer.
                </ul>
              </div>
              <div class="small-12 large-6 panel columns">
                <img src="images/RegistrationCode.jpg" alt="authorize"><br />
                <span class="imgNote">[Image 12]. Registration Code.</span>
              </div>
              <p><span class="important">Note: </span> the code can be found in the controller "AccountController" can be found at: /controllers/AccountController.cs, the model "AccountModels.cs" found at /Models/AccountModels and the view "register.cshtml" found at: /Views/Account/register.cshtml.</p>
            </div>
            <div class="small-12 large-12 columns"> <!-- login -->
              <h5 class="cheaders">8.2 Login</h5>
              <hr class="chr">
              <div class="panel callout radius">
                <p>MISSING</p>
              </div>
              <p><span class="important">MISSING Note: </span> the code can be found in the controller "AccountController" can be found at: /controllers/AccountController.cs, the model "AccountModels.cs" found at /Models/AccountModels and the view "register.cshtml" found at: /Views/Account/register.cshtml.</p>
            </div>
            <div class="small-12 large-12 columns"> <!-- register a call -->
              <h5 class="cheaders">8.3 Register a call</h5>
              <hr class="chr">
              <p class="panel callout radius">The main flow of actions for this module can be found in the diagram <a href="#callRegistration">Call Registration</a>. The main features of this component are: Validation (see section <a href="#validation">Validation</a> for more information); Ajax communication to retrieve information given a phone number, in order to fill fields automatically and create historic table; create a new entry in the database.</p>
              <p>Besides ASP.NET MVC the technologies used are: Jquery, Ajax, JSON.</p>
              <div class="small-12 large-12 columns"> <!-- Register a call ajax/json -->
                <h6 class="cheaders">7.3.1 Register a call - submit - Ajax/Json</h6>
                <hr class="chr">
                <p class="panel callout radius">The component was designed to communicate with the database via AJAX with the objective to provide fast and dynamic information to the employee, without the need to refresh the web page or go to another component.</p>
                <p>After the user submits the form the first action from the system is to validate the fields, if all the fields are correct the data is going to be serialize in JSON format and send to the controller, the class that executes this action is Registration.js <span class="imgNote">(code in "/Scripts/Custom/registration.js")</span>, as shown below:</p>
                <div class="small-12 large-6 columns">
                  <div class="panel">
                  <span class="important">Registration.js</span>
<pre>
if ($("form").valid()) {   
  // Disable the button
  $('input[type="submit"]').prop('disabled', true);
  $.ajax({
     type: "POST",
     url: form.attr('action'),
     dataType: 'json',
     ContentType: 'application/json',
     data: $("form").serialize()
}) 
...
</pre>      
                <br />
                <span class="imgNote">1. First step, data serialize and send to controller.</span>
              </div>
                </div> <!-- registration .js -->
                <div class="small-12 large-6 columns">
                  <div class="panel">
                  <span class="important">Registration.js</span>. After the response from the controller:
<pre>
 if (data === true) {
    $('input[type="submit"]').prop('disabled', false);
    $('div#messages').attr('class', 'alert-box success radius');
    $('div#messages').show();
    $('div#messages').text("The information of the call has been successfully saved").fadeOut(4000);
    // Clean the fields of the form to leave them ready the form for the next call.
    $('input#PhoneNumber').val('');
...
}
...
</pre>          <br />
                <span class="imgNote">3. Third step, the javascript receives the data from the controller and displays the message.</span>
              </div>
                </div> <!-- registration .js -->

                <div class="small-12 large-12 columns">
                  <div class="panel">
                  <span class="important">CallController.cs</span>
                  The action in the controller will return JSON. If model is valid and the person who called is already registered on the database, his address is going to be update it. Otherwise, register a new person and a new call.
<pre>
[HttpPost]
public JsonResult Register(Models.Registration registration)
...
if (ModelState.IsValid)
{
...
  var aux = (from ca in db.Categories
             where ca.CategoryName.Equals(registration.Categories)
             select ca).Single();
  Person person = new Person(registration.PhoneNumber, registration.Name, registration.LastName, registration.Address1, registration.Address2, registration.PostCode);
  // Check if a person already exists on the table with that phone number.
  var checkPerson = db.Persons.Any(p => p.PhoneNumber == person.PhoneNumber);
  var userName = WebSecurity.CurrentUserName;
  var checkEmployee = db.Employees.Any(e => e.Name == userName);
  Employee tmpEmployee = null;

  if(checkEmployee)
      tmpEmployee = db.Employees.Single(e => e.Name == userName);

  if (checkPerson && checkEmployee)
  {
      Person tmpPerson = db.Persons.Single(p => p.PhoneNumber == person.PhoneNumber)
      if (TryUpdateModel(tmpPerson, new string[] { "Name", "LastName", "Address1", "Address2", "PostCode" }))
      {
        ...
        db.Entry(tmpPerson).State = EntityState.Modified;
        db.SaveChanges();
        Call call = new Call(aux.CategoryId, tmpEmployee.EmployeeId, registration.Program, registration.Comments, registration.Positive, tmpPerson);
        db.Calls.Add(call);
        db.SaveChanges();
        ...
      }
  }
  else
  {
      Call call = new Call(aux.CategoryId, tmpEmployee.EmployeeId, registration.Program, registration.Comments, registration.Positive, person);
      db.Calls.Add(call);
      db.SaveChanges();
  }
  return Json(true);
  ...
}
return Json(false);
</pre>
                <br />
                <span class="imgNote">2. Second step, response in JSON format from the controller.</span>
              </div>
                </div> <!-- controller -->
              </div> <!-- register a call submit -->
              <div class="small-12 large-12 columns"> <!-- Register a call - phone number - ajax/json -->
                <h6 class="cheaders">7.3.2 Register a call - phone number typed - Ajax/Json</h6>
                <hr class="chr">
                <p class="panel callout radius">After a user type the phone number, the .js file will read the value and communicate with the controller to retrieve information about the person.</p>
                <div class="small-12 large-6 columns">
                  <div class="panel">
                  <span class="important">Registration.js</span>. User focus out from the phone number field, an ajax call will be created:
<pre>
...
$.ajax({
    type: 'POST',
    url: '/Call/Complete',
    data: { phoneNumber: phoneNumber },
    dataType: "json",
    ContentType: 'application/json'
})
...
</pre>        
                  <br />
                  <span class="imgNote">1. First step, get phone number value and communicate with the controller.</span>
                </div>
              </div> <!-- registration .js -->
              <div class="small-12 large-6 columns">
                  <div class="panel">
                  <span class="important">Registration.js</span>. After the response from the controller, fill the fields with the data:
<pre>
...
.success(function (data) {
if (data !== false) {
    // Clean error messages from the screen and append the span back to be able to show future error messages.
    $('span[data-valmsg-for="PhoneNumber"]').remove();
    $('#errorPhoneNumber').append("<span class='field-validation-valid' data-valmsg-for='PhoneNumber' data-valmsg-replace='true'></span>");
    $('input#Name').val(data.Name);
    $('span[data-valmsg-for="Name"]').remove();
    $('#errorName').append("<span class='field-validation-valid' data-valmsg-for='Name' data-valmsg-replace='true'></span>");
    $('input#LastName').val(data.LastName);
...
</pre>      
                  <br />
                  <span class="imgNote">3. Third step, fill in the fields.</span>
                </div>
              </div> <!-- registration .js -->
              <div class="small-12 large-12 columns">
                <div class="panel">
                  <span class="important">CallController.cs, Complete action</span>
                  The action in the controller will return the model modified in JSON format.
<pre>
[HttpPost]
public JsonResult Complete(Models.Registration registration)
{
    var aux = db.Persons.Any(p => p.PhoneNumber == registration.PhoneNumber);
    if (aux)
    {
        Person tmpPerson = db.Persons.Single(p => p.PhoneNumber == registration.PhoneNumber);

        registration.Name = tmpPerson.Name;
        registration.LastName = tmpPerson.LastName;
        registration.Address1 = tmpPerson.Address1;
        registration.Address2 = tmpPerson.Address2;
        registration.PostCode = tmpPerson.PostCode;
        return Json(registration);
    }
    return Json(false);
}
</pre>
                <br />
                <span class="imgNote">2. Second step, the controller modifies the received model.</span>
              </div>
            </div>
              </div> <!-- phone number typed -->
              <div class="small-12 large-12 columns"> <!-- Register a call phone typed - ajax/json -->
                <h6 class="cheaders">7.3.3 Register a call - historical data - Ajax/Json</h6>
                <hr class="chr">
                <p class="panel callout radius">After a user type the phone number, the .js file will read the value and communicate with the controller to retrieve information about the historical data of the person.</p>
                <div class="small-12 large-12 columns">
                  <div class="panel">
                  <span class="important">Registration.js</span>. User focus out from the phone number field, an ajax call will be created:
<pre>
...
 $.ajax({
    type: 'POST',
    url: '/Call/Historical',
    data: { phoneNumber: phoneNumber },
    dataType: "json",
    ContentType: 'application/json'
})
...
</pre>      
                  <br />
                  <span class="imgNote">1. First step, get phone number value and communicate with the controller.</span>
                </div>
              </div> <!-- registration .js -->
              <div class="small-12 large-12 columns">
                <div class="panel">
                  <span class="important">CallController.cs, Complete action</span>
                  The action in the controller will return the model modified in JSON format.
<pre>
...
var aux = db.Persons.Any(p => p.PhoneNumber == registration.PhoneNumber);
if (aux)
{
    Person tmpPerson = db.Persons.Single(p => p.PhoneNumber == registration.PhoneNumber);
    var bCalls = db.Calls.Any(c => c.Person.PersonId == tmpPerson.PersonId);
    if (bCalls)
    {
        var calls = (from ca in db.Calls
                     join a in db.Categories on ca.CategoryId equals a.CategoryId
                     where ca.Person.PersonId == tmpPerson.PersonId
                     orderby ca.TimeCall descending
                     select new {ca.Program, a.CategoryName, ca.Comments, ca.Positive, ca.TimeCall});

        List<Historic> lCall = new List<Historic>();
        int cPositive = 0;
        int cNegative = 0;
        foreach (var c in calls)
        {
            Historic call = new Historic(c.Program, c.CategoryName, c.Comments, c.Positive, c.TimeCall.ToString());
            if (c.Positive)
                cPositive++;
            else
                cNegative++;
            lCall.Add(call);
        }
        return Json(new { Name = tmpPerson.Name, LastName = tmpPerson.LastName, Address1 = tmpPerson.Address1, Address2 = tmpPerson.Address2, PostCode = tmpPerson.PostCode, nPositive = cPositive, nNegative = cNegative, Calls = lCall });
    }
    else
        return Json(false);
...
</pre>  
                <br />
                <span class="imgNote">2. Second step, the controller modifies the received model.</span>
              </div>
            </div>
            <div class="small-12 large-6 columns">
                  <div class="panel">
                  <span class="important">Registration.js</span>. After the response from the controller, send message about reputation from the person:
<pre>
...
// Check if the number of positive comments are equal to the number of negative comments
if (data.nPositive === data.nNegative) {
    $('div#messages').attr('class', 'alert-box info round');
    $('div#messages').show();
    $('div#messages').text("The user has the same number of positive and negative comments").fadeOut(3000);
}
else if (data.nPositive > data.nNegative) {
    // Notify if the user has a good reputation (more positive comments than negative)
    $('div#messages').attr('class', 'alert-box info round');
    $('div#messages').show();
    $('div#messages').text("The user has a reputation of positive comments").fadeOut(3000);
}
else {
    // Notify if the user has a bad reputation when calling (more negative comments than positive)
    $('div#messages').attr('class', 'alert-box warning round');
    $('div#messages').show();
    $('div#messages').text("The user has a reputation of negative comments").fadeOut(3000);
...
</pre>      
                  <br />
                  <span class="imgNote">3. Third step part 1, show message regard the reputation.</span>
                </div>
              </div> <!-- registration .js -->
              <div class="small-12 large-6 columns">
                  <div class="panel">
                    <span class="important">Registration.js</span>. Part 2, create table with historical data.
                    <img src="images/phone_historical.png" alt="code"><br />    
                    <span class="imgNote">4. Third step part 2, historical data.</span>
                  </div>
                  
              </div> <!-- registration .js -->
              </div> <!-- phone number historical typed -->
              <div class="small-12 large-12 columns">
                <hr class="chr">
                <p><span class="important">Note: </span> the javascript file "Registration.js" can be found at /Scripts/Custom/registration.js, the controller "CallController" can be found at: /controllers/CallController.cs, model used "Registration" found at: /Models/Registration.cs, View used "Register.cshtml" found at: /Views/Call/Register.cshtml</p>
              </div>
            </div> <!-- register a call -->
            <!-- search -->
            <div class="small-12 large-12 columns"> 
              <h5 class="cheaders">8.4 Search a person</h5>
              <hr class="chr">
              <p class="panel callout radius">The main flow of actions for this module can be found in the diagram <a href="#searchPerson">Search person</a>. The main features of this component are: Validation (see section <a href="#validation">Validation</a> for more information); Ajax communication to retrieve information given a a name or phone number, in order to create a table with the results.</p>
              <div class="small-12 large-6 columns">
                <div class="panel">
                  <span class="important">search.js</span>. User select a search criteria, typed a value and clicked on the button:
<pre>
...
$.ajax({
    type: "POST",
    url: form.attr('action'),
    dataType: 'json',
    ContentType: 'application/json',
    data: $("form").serialize()
    //data: stringfied
})
...
</pre>      
                  <br />
                  <span class="imgNote">Use ajax to communicate with the controller.</span>
                </div>
              </div> <!-- search .js -->
              <div class="small-12 large-6 columns">
                <div class="panel">
                  <span class="important">PersonController, search action</span>. The controller receives the data and looks in the database to retrieve the information.
<pre>
[HttpPost]
public JsonResult Search(Models.Search search)
{
    if (search.Criteria.ToLower().Equals("phone number"))
    {
        int n;
        bool isNumeric = int.TryParse(search.Value, out n);
        if (isNumeric)
        {
            var checkPerson = db.Persons.Any(p => p.PhoneNumber == n);
            if (checkPerson)
            {
                var people = (from p in db.Persons
                              where p.PhoneNumber == n
                              orderby p.PhoneNumber descending
                              select p);

                List<Person> lPerson = new List<Person>();
                foreach (var p in people)
                {
                    Person person = new Person(p.PersonId, p.PhoneNumber, p.Name, p.LastName, p.Address1, p.Address2, p.PostCode);
                    lPerson.Add(person);
                }
                return Json(new { success = true, people = lPerson });
            }
            else
                return Json(new { success = false, errorMessage = "No results found" });

        }
        else
            return Json(new { success = false, errorMessage = "The phone number must be only digits" });
    }
    else if (search.Criteria.ToLower().Equals("name"))
    {
        var checkPerson = db.Persons.Any(p => p.Name.Contains(search.Value) || p.LastName.Contains(search.Value));
        if (checkPerson)
        {
            var people = (from p in db.Persons
                          where p.Name.Contains(search.Value) || p.LastName.Contains(search.Value)
                          orderby p.LastName descending
                          select p);

            List<Person> lPerson = new List<Person>();
            foreach (var p in people)
            {
                Person person = new Person(p.PersonId, p.PhoneNumber, p.Name, p.LastName, p.Address1, p.Address2, p.PostCode);
                lPerson.Add(person);
            }
            return Json(new { success = true, people = lPerson });
        }
        else
            return Json(new { success = false, errorMessage = "No results found" });

    }
    return Json(new { success = false, errorMessage = "Criteria must be name or phone number" });
}
</pre>
                </div>
              </div>
              <div class="small-12 large-6 columns">
                <div class="panel">
                  <span class="important">search.js</span>. The response is received a message is displayed on the screen (success or failure).
<pre>
...
$('input[type="submit"]').prop('disabled', false);
$('div#messages').attr('class', 'alert-box success radius');
$('div#messages').show();
$('div#messages').text("Search successful").fadeOut(4000);
...
$('div#messages').attr('class', 'alert-box alert radius');
$('div#messages').show();
$('div#messages').text(data.errorMessage).fadeOut(4000);
$('input[type="submit"]').prop('disabled', false);
...
</pre>      
                  <br />
                  <span class="imgNote">Code to generate/show the messages.</span>
                </div>
              </div> <!-- search .js -->
              <div class="small-12 large-6 columns">
                <div class="panel">
                  <span class="important">search.js</span>. Besides the message, the table is generated.
                   <img src="images/history_results.png" alt="code"><br />    
                  <span class="imgNote">Code to generate results table.</span>
                </div>
              </div> <!-- search .js -->
              <!-- NOTE -->
              <div class="small-12 large-12 columns">
                <hr class="chr">
                <p><span class="important">Note: </span> the javascript file "search.js" can be found at /Scripts/Custom/search.js, the controller "PersonController" can be found at: /controllers/PersonController.cs, model used "Search" found at: /Models/Search.cs, View used "search.cshtml" found at: /Views/Person/search.cshtml</p>
              </div>
              <!-- 8.4.1 check history -->
               <div class="small-12 large-12 columns"> 
                <h6 class="cheaders">8.4.1 Search a person - check history</h6>
                <hr class="chr">
                <p class="panel callout radius">In the past section a table was generated with the data from the database, in the table a link is created to check the history of one person.</p>
                <div class="small-12 large-6 columns">
                  <div class="panel">
                    <span class="important">PersonController - Details action</span>. Receives the ID of a user.
  <pre>
[HttpGet]
public ActionResult Details(long id)
{
    var checkPerson = db.Persons.Any(p => p.PersonId.Equals(id));
    if (checkPerson)
    {
        Person p = db.Persons.Single(per => per.PersonId == id);
        var calls = (from call in db.Calls
                    join categories in db.Categories on call.CategoryId equals categories.CategoryId
                    join person in db.Persons on call.Person.PersonId equals person.PersonId
                    where call.Person.PersonId == id
                    orderby call.TimeCall descending
                    select new { call.Program, categories.CategoryName, call.Comments, call.Positive, call.TimeCall});
        List<Historic> lCall = new List<Historic>();
        foreach (var c in calls)
        {
            Historic call = new Historic(c.Program, c.CategoryName, c.Comments, c.Positive, c.TimeCall.ToString());
            lCall.Add(call);
        }
        Details details = new Details(lCall, p);
        return View(details);
    }
    return View();
}
  </pre>      
                    <br/>
                    <span class="imgNote">Action code in the controller.</span>
                  </div> <!--panel-->
                </div> <!-- controller -->
                <div class="small-12 large-6 columns">
                  <div class="panel">
                    <span class="important">View: Details.cshtml</span>. Display general information about the user (personal information) and all the calls registered.
                    ...
                    <img src="images/general_info.png" alt="code"><br />
                    <br />...
                    <img src="images/calls_table.png" alt="code"><br />
                    ...<br />
                    <span class="imgNote">Code in the view display information.</span>     
                  </div> <!--panel-->
                </div> <!-- View -->
              </div> <!-- end 8.4.1 check history -->
               <!-- NOTE -->
              <div class="small-12 large-12 columns">
                <hr class="chr">
                <p><span class="important">Note: </span> the controller "PersonController" (details action) can be found at: /controllers/PersonController.cs, model used "Details" found at: /Models/Details.cs, View used "details.cshtml" found at: /Views/Person/details.cshtml</p>
              </div>
            </div><!-- end search -->
            <!-- Charts -->
            <div class="small-12 large-12 columns"> 
              <h5 class="cheaders">8.5 Charts</h5>
              <hr class="chr">
              <p class="panel callout radius">The main flow of actions for this module can be found in the diagram <a href="#chartsFlow">charts</a>. The main features of this component are: Validation (see section <a href="#validation">Validation</a> for more information); Ajax communication to retrieve calls information for the specified range of dates, generation of charts. Use of JQuery-UI to use calendar for the dates.</p>
              <p><span class="important">Note: </span> it is required to have highcharts.js script in order to generate the charts.</p>
              <div class="small-12 large-12 columns">
                <div class="small-12 large-6 columns">
                  <div class="panel">
                    <span class="important">JQuery-UI calendar</span>. JQuery.cs, JQuery-UI.js and JQuery-ui-*.css are required.
  <pre>
$(function () {
  $("#FromDate").datepicker({
      defaultDate: "+1w",
      changeMonth: true,
      numberOfMonths: 3,
      onClose: function (selectedDate) {
          $("#ToDate").datepicker("option", "minDate", selectedDate);
      }
  });
  $("#ToDate").datepicker({
      defaultDate: "+1w",
      changeMonth: true,
      numberOfMonths: 3,
      onClose: function (selectedDate) {
          $("#FromDate").datepicker("option", "maxDate", selectedDate);
      }
  });
});
  </pre>      
                    <br/>
                    <span class="imgNote">JQuery - UI calendar.</span>
                  </div> <!--panel-->
                </div> <!-- calendar -->
                <div class="small-12 large-6 columns">
                  <div class="panel">
                    <span class="important">Charts.js</span>. Communicates with the controller via Ajax.
  <pre>
$.ajax({
    type: "POST",
    url: '/Chart/GetInfo',
    dataType: 'json',
    ContentType: 'application/json',
    data: $("form").serialize()
})
  </pre>      
                    <br/>
                    <span class="imgNote">Charts script - ajax.</span>
                  </div> <!--panel-->
                </div> <!-- charts -->
              </div><!-- row-->
             <div class="small-12 large-12 columns">
              <div class="small-12 large-6 columns">
                  <div class="panel">
                    <span class="important">ChartController - Get info action</span>. Retrieves calls information between the range of dates and sends the data in JSON format.
  <pre>
[HttpPost]
public JsonResult GetInfo(Models.Chart charts)
{
    if (ModelState.IsValid)
    {
        DateTime fromDate = Convert.ToDateTime(charts.FromDate);
        DateTime toDate = Convert.ToDateTime(charts.ToDate);

        var checkCall = db.Calls.Any(c => c.TimeCall >= fromDate && c.TimeCall <= toDate);
        if (checkCall)
        {
            var calls = (from call in db.Calls
                         join categories in db.Categories on call.CategoryId equals categories.CategoryId
                         join person in db.Persons on call.Person.PersonId equals person.PersonId
                         where call.TimeCall >= fromDate && call.TimeCall <= toDate
                         orderby call.TimeCall ascending
                         select new { call.Program, categories.CategoryName, call.Comments, call.Positive, call.TimeCall, call.Person.PersonId });
 ...
 return Json(new { success = true, FromDate = charts.FromDate, ToDate = charts.ToDate, CategoryNames = lCategories, CategoryCount = iCategories, Dates = lDates, DatesCount = iDates, People = iPeople, Positive = nPositive, Negative = nNegative, PMorning = pMorning, PAfternoon = pAfternoon, TotalCalls = totalCalls });
}
else
    return Json(new { success = false, errorMessage = "No calls registered between " + charts.FromDate + " to " + charts.ToDate});
...
  </pre>      
                    <br/>
                    <span class="imgNote">Get info from the controller/action.</span>
                  </div> <!--panel-->
                </div> <!-- controller -->
                <div class="small-12 large-6 columns">
                  <div class="panel">
                    <span class="important">charts.js</span>. Show message, create section of general information and manipulate data to create charts.
  <pre class="sPerson2">
$('div#messages').attr('class', 'alert-box success radius');
$('div#messages').show();
$('div#messages').text("Calls found between " + data.FromDate + " to " + data.ToDate).fadeOut(4000);
...
</pre>
                        <img src="images/charts_code.png" alt="code"><br />
<pre>
series: [{
    name: 'Calls on the day',
    data: nCalls
}]
...
  </pre>      
                    <br/>
                    <span class="imgNote">Display message, general information and generate charts.</span>
                  </div> <!--panel-->
                </div> <!-- charts -->
             </div><!-- row-->
            </div> <!-- 8.5 -->
            <div class="small-12 large-12 columns">
              <hr class="chr">
              <p><span class="important">Note: </span> the controller "ChartsController" (action: getInfo) can be found at: /controllers/ChartController.cs, model used "Chart" found at: /Models/Chart.cs, View used "index.cshtml" found at: /Views/Chart/index.cshtml</p>
            </div>
            <div class="small-12 large-12 columns"> <!-- control panel -->
              <h5 class="cheaders">8.6 Control Panel</h5>
              <hr class="chr">
              <p class="panel callout radius">MISSING The main flow of actions for this module can be found in the diagram <a href="#chartsFlow">charts</a>. The main features of this component are: Validation (see section <a href="#validation">Validation</a> for more information); Ajax communication to retrieve calls information for the specified range of dates, generation of charts. Use of JQuery-UI to use calendar for the dates.</p>
              <!-- 8.4.1 check history -->
               <div class="small-12 large-12 columns"> 
                <h6 class="cheaders">8.6.1 Control Panel - List of Roles</h6>
                <hr class="chr">
                  <div class="small-12 large-12 columns">
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">View Board.cshtml</span>. To obtain the roles Ajax is used.
      <pre>
    @Ajax.ActionLink("List of Roles", "UserRole", new AjaxOptions()
    {
        HttpMethod = "GET",
        UpdateTargetId = "divHi",
        InsertionMode = InsertionMode.Replace
    })
      </pre>      
                        <br/>
                        <span class="imgNote">Ajax call.</span>
                      </div> <!--panel-->
                    </div> <!-- calendar -->
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">Account Controller</span>. Obtain roles and display.
      <pre>
    [AuthorizeRedirect(Roles = "Admin")]
    public PartialViewResult UserRole()
    {
        var roles = Roles.GetAllRoles();
        return PartialView("_IndexOfRoles", roles);
    }
      </pre>      
                        <br/>
                        <span class="imgNote">Roles from the controller.</span>
                      </div> <!--panel-->
                    </div> <!-- charts -->
                  </div><!-- row-->
                </div>
                <div class="small-12 large-12 columns"> 
                  <h6 class="cheaders">8.6.2 Control Panel - Add roles</h6>
                  <hr class="chr">
                  <div class="small-12 large-12 columns">
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">AccountController (action: RoleAddToUser)</span>. Link a user to a role.
<pre>
[AuthorizeRedirect(Roles = "Admin")]
[HttpPost]
[ValidateAntiForgeryToken]
public ActionResult RoleAddToUser(string RoleName, string UserName)
{
    if (Roles.IsUserInRole(UserName, RoleName))
    {
        ViewBag.ResultMessage = "This user already has the role specified !";
    }
    else
    {
        Roles.AddUserToRole(UserName, RoleName);
        ViewBag.ResultMessage = "Username added to the role succesfully !";
    }

    SelectList list = new SelectList(Roles.GetAllRoles());
    ViewBag.Roles = list;
    return View();
}
</pre>      
                        <br/>
                        <span class="imgNote">Add role to a user.</span>
                      </div> <!--panel-->
                    </div> <!-- item -->
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">Add role to user</span>.
                         <img src="images/hasArole.jpg" alt="code"><br /> 
                        <span class="imgNote">Add role.</span>
                      </div> <!--panel-->
                    </div> <!-- charts -->
                  </div><!-- row-->
                </div><!--8.6.2 -->
                <div class="small-12 large-12 columns"> 
                  <h6 class="cheaders">8.6.3 Control Panel - Get roles</h6>
                  <hr class="chr">
                  <div class="small-12 large-12 columns">
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">AccountController (action: GetRoles)</span>. Get roles of a user.
<pre>
[AuthorizeRedirect(Roles = "Admin")]
[HttpPost]
[ValidateAntiForgeryToken]
public ActionResult GetRoles(string UserName)
{
    if (!string.IsNullOrWhiteSpace(UserName))
    {
        ViewBag.RolesForThisUser = Roles.GetRolesForUser(UserName);
        SelectList list = new SelectList(Roles.GetAllRoles());
        ViewBag.Roles = list;
    }
    return View("RoleAddToUser");
}
</pre>      
                        <br/>
                        <span class="imgNote">Get roles.</span>
                      </div> <!--panel-->
                    </div> <!-- item -->
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">Get roles</span>.<br />
                         <img src="images/getRoles.jpg" alt="code"><br /> 
                        <span class="imgNote">Get roles.</span>
                      </div> <!--panel-->
                    </div> <!-- charts -->
                  </div><!-- row-->
                </div><!--8.6.3-->
                <div class="small-12 large-12 columns"> 
                  <h6 class="cheaders">8.6.4 Control Panel - Delete roles</h6>
                  <hr class="chr">
                  <div class="small-12 large-12 columns">
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">AccountController (action: DeleteRoleForUser)</span>. Delete roles for a user.
<pre>
[HttpPost]
[AuthorizeRedirect(Roles = "Admin")]
[ValidateAntiForgeryToken]
public ActionResult DeleteRoleForUser(string UserName, string RoleName)
{
    if (Roles.IsUserInRole(UserName, RoleName))
    {
        Roles.RemoveUserFromRole(UserName, RoleName);
        ViewBag.ResultMessage = "Role has been removed from the user successfully !";
    }
    else
    {
        ViewBag.ResultMessage = "This user doesn't have a selected role.";
    }
    ViewBag.RolesForThisUser = Roles.GetRolesForUser(UserName);
    SelectList list = new SelectList(Roles.GetAllRoles());
    ViewBag.Roles = list;

    return View("RoleAddToUser");
}
</pre>      
                        <br/>
                        <span class="imgNote">Delete role to a user.</span>
                      </div> <!--panel-->
                    </div> <!-- item -->
                    <div class="small-12 large-6 columns">
                      <div class="panel">
                        <span class="important">Delete role to user</span>.<br />
                         <img src="images/DeleteRole1.jpg" alt="code"><br /> 
                        <span class="imgNote">Delete role.</span>
                      </div> <!--panel-->
                    </div> <!-- charts -->
                  </div><!-- row-->
                </div><!--8.6.4-->
            </div>
          </div><!-- end implementation -->
          <div class="small-12 large-12 columns"> <!-- control panel -->
              <h5 class="cheaders">9. Discussion</h5>
              <hr class="chr">
          </div>
          <div class="small-12 large-12 columns"> <!-- control panel -->
              <h5 class="cheaders">10. References</h5>
              <hr class="chr">
              <blockquote>Example</blockquote>
          </div>
        </section>

        <footer class="large-12 columns cfooter">
            <div class="panel">
              <p class="pPanel">&copy; 2014 - Store Calls System Manuals</p>
            </div>
        </footer>
        <script src="js/jquery-1.7.1.js"></script>
        <script src="js/responsive-tables.js"></script>
        <script src="js/foundation.js"></script>
        <script src="js/foundation.topbar.js"></script>
        <script src="js/foundation.magellan.js"></script>
        <script src="js/custom.js"></script>
        <script>
            $(document).foundation();
        </script>
    </body>
</html>  